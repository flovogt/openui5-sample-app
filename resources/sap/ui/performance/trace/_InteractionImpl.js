/*!
 * OpenUI5
 * (c) Copyright 2025 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/performance/Measurement","sap/ui/performance/XHRInterceptor","sap/ui/performance/trace/FESRHelper","sap/ui/util/isCrossOriginURL","sap/base/util/LoaderExtensions","sap/base/util/now","sap/base/util/uid","sap/base/Log"],function(e,t,n,i,r,s,o,a){"use strict";let u=false,p=false,c=[],f,d,g=false,l=false,m,h=0,y=0,T=0,b=false,S=false,I,E,v;const L=Symbol("ui5Url");const R=Symbol("ui5Url");const q=new Map;const N={"application/zip":true,"application/vnd.rar":true,"application/gzip":true,"application/x-tar":true,"application/java-archive":true,"image/jpeg":true,"application/pdf":true},_="zip,rar,arj,z,gz,tar,lzh,cab,hqx,ace,jar,ear,war,jpg,jpeg,pdf,gzip";let A;let C;let H=[];function w(e){return{event:"startup",trigger:"undetermined",component:"undetermined",appVersion:"undetermined",start:e,preliminaryEnd:0,end:0,navigation:0,roundtrip:0,processing:0,duration:0,requests:[],measurements:[],sapStatistics:[],requestTime:0,networkTime:0,bytesSent:0,bytesReceived:0,requestCompression:"X",busyDuration:0,id:o(),passportAction:"undetermined_startup_0",rootId:undefined,fesrecTime:0,fesrecRequestTime:0,fesrecRequestCount:0}}function O(e){if(e.start>f.start&&e.end<f.end){return e}}function P(e){const t=f.start-performance.timeOrigin<=e.startTime&&f.end-performance.timeOrigin>=e.responseEnd;const n=f.start-performance.timeOrigin<=e.startTime;const r=e[R];const s=e.transferSize===0&&e.decodedBodySize>=0;const o=!s&&!i(e.name)&&r&&t&&e.initiatorType==="xmlhttprequest";if(n){A??={navigation:0,roundtrip:0,roundtripLowerLimit:f.start-performance.timeOrigin?e.startTime:0,roundtripHigherLimit:e.responseEnd};z(e,A)}if(o){C??={navigation:0,roundtrip:0,roundtripLowerLimit:e.startTime,roundtripHigherLimit:e.responseEnd};z(e,C);f.bytesReceived+=r.bytesReceived;f.bytesSent+=r.bytesSent;f.requestCompression=r.requestCompression&&f.requestCompression!==false;f.requestTime+=e.responseEnd-e.startTime;if(r.fesrecTime){f.fesrecTime+=r.fesrecTime;f.fesrecRequestTime+=e.responseEnd-e.startTime;f.fesrecRequestCount++}}return o}function z(e,t){if(e.responseEnd<=f.end-performance.timeOrigin){if(t.roundtripHigherLimit<=e.startTime){t.roundtrip+=t.roundtripHigherLimit-t.roundtripLowerLimit;t.roundtripLowerLimit=e.startTime;t.roundtripHigherLimit=e.responseEnd}else if(e.responseEnd>t.roundtripHigherLimit){t.roundtripHigherLimit=e.responseEnd}}else if(e.startTime<f.end-performance.timeOrigin){t.roundtripHigherLimit=f.end-performance.timeOrigin}t.navigation+=e.requestStart?e.requestStart-e.startTime:0}function D(t){if(f){let n;f.legacyEndTime=f.legacyEndTime||s();f.legacyDuration=f.legacyEndTime-f.start;f.end=t;f.duration=f.end-f.start;H.push(...performance.getEntriesByType("resource"));H.sort((e,t)=>e.startTime-t.startTime);f.requests=H.filter(P);f.roundtrip=C?C.roundtrip+(C.roundtripHigherLimit-C.roundtripLowerLimit):0;f.navigation=C?C.navigation:0;f.roundtripAllRequests=A?A.roundtrip+(A.roundtripHigherLimit-A.roundtripLowerLimit):0;if(f.fesrecTime){const e=f.fesrecRequestTime-f.fesrecTime;f.networkTime=e/f.fesrecRequestCount}else{f.networkTime=0}f.completeRoundtrips=0;f.measurements=e.filterMeasurements(O,true);f.completeRoundtrips=f.requests.length;const i=f.duration-f.roundtripAllRequests;f.processing=y>0?-1:i;f.completed=true;if(f.semanticStepName||f.duration>=2||f.requests.length>0||u){c.push(f);n=c[c.length-1];if(a.isLoggable()){a.debug("Interaction step finished: trigger: "+f.trigger+"; duration: "+f.duration+"; requests: "+f.requests.length,"_InteractionImpl.js")}}if(I?.onInteractionFinished){I.onInteractionFinished(n)}Object.freeze(f);A=null;C=null;f=null;d=null;u=false;l=false;g=false;H=[];clearTimeout(p)}}function j(e){let t,n,i;if(e){const r=sap.ui.require("sap/ui/core/Component");if(r){while(e&&e.getParent){let s=r.getOwnerComponentFor(e);if(s||e instanceof r){s=s||e;const r=s.getManifestEntry("sap.app");n=s.getId();t=r&&r.id||s.getMetadata().getName();i=r&&r.applicationVersion&&r.applicationVersion.version}e=e.getParent()}}}return{id:n,name:t?t:"undetermined",version:i?i:""}}function B(){const e=Object.getOwnPropertyDescriptor(HTMLScriptElement.prototype,"src");Object.defineProperty(HTMLScriptElement.prototype,"src",{set:function(t){var n;if(!this.dataset.sapUiCoreInteractionHandled){n=F.notifyAsyncStep("request");this.addEventListener("load",function(){n()});this.addEventListener("error",function(){n()});this.dataset.sapUiCoreInteractionHandled="true"}e.set.call(this,t)},get:e.get})}function M(){t.register("INTERACTION","send",function(){if(this.oPendingInteraction&&!i(this[L])){q.get(this._id).bytesSent+=arguments[0]?arguments[0].length:0}});t.register("INTERACTION","setRequestHeader",function(e,t){if(f&&!i(this[L])){q.get(this._id).bytesSent+=(e+"").length+(t+"").length}});t.register("INTERACTION","open",function(e,t,n){this[L]=new URL(t,document.baseURI).href;if(f&&!i(this[L])){this.addEventListener("readystatechange",k.bind(this,f.id,F.notifyAsyncStep("request")));const e=Object.create(null);e.bytesSent=0;e.pendingInteraction=f;q.set(this._id,e)}})}function U(e,t,n,i){var r=e.split(".").pop().split(/\#|\?/)[0];if(t==="gzip"||t==="br"||n in N||r&&_.indexOf(r)!==-1||i<1024){return true}else{return false}}function k(e,t){if(this.readyState===4){const n=q.get(this._id);let i=performance.getEntriesByType("resource");H.push(...i);performance.clearResourceTimings();if(i.length&&!f?.completed&&f?.id===e){if(n){i=i.filter(e=>e.name===this[L]&&e.decodedBodySize!==0&&e.transferSize!==0);if(i.length){const e=this.getResponseHeader("content-length"),t=U(this.responseURL,this.getResponseHeader("content-encoding"),this.getResponseHeader("content-type"),e),r=this.getResponseHeader("sap-perf-fesrec");n.bytesReceived=e?parseInt(e):0;n.bytesReceived=this.getAllResponseHeaders().length;n.requestCompression=t;n.fesrecTime=r?Math.round(parseFloat(r,10)/1e3):0;const s=this.getResponseHeader("sap-statistics");i[0][R]=n;if(s){n.pendingInteraction.sapStatistics.push({url:this.responseURL,statistics:s,timing:i?i[i.length-1]:undefined})}}}}t()}}var F={getAll:function(e){if(e){F.end(true)}return c},filter:function(e){var t=[];if(e){for(var n=0,i=c.length;n<i;n++){if(e(c[n])){t.push(c[n])}}}return t},getPending:function(){return f},clear:function(){c=[]},start:function(e,t){const i=e==="startup"?performance.timeOrigin:s();if(f){D(i)}if(m){clearTimeout(m)}T=0;h=0;y=0;if(e!=="startup"&&performance.clearResourceTimings){performance.clearResourceTimings()}f=w(i);const r=j(t);f.componentId=r.id;f.component=r.name;f.event=e;f.appVersion=r.version;if(t&&t.getId){f.trigger=t.getId();f.semanticStepName=n.getSemanticStepname(t,e)}if(a.isLoggable(null,"sap.ui.Performance")){console.time("INTERACTION: "+f.trigger+" - "+f.event)}if(a.isLoggable()){a.debug("Interaction step started: trigger: "+f.trigger+"; type: "+f.event,"_InteractionImpl.js")}},end:function(e){if(f){if(e){if(a.isLoggable(null,"sap.ui.Performance")){console.timeEnd("INTERACTION: "+f.trigger+" - "+f.event)}D(f.preliminaryEnd||s());if(a.isLoggable()){a.debug("Interaction ended...")}}else{f.preliminaryEnd=s()}}},notifyNavigation:function(){u=true},notifyShowBusyIndicator:function(e){e._sapui_fesr_fDelayedStartTime=s()+e.getBusyIndicatorDelay()},notifyHideBusyIndicator:function(e){if(e._sapui_fesr_fDelayedStartTime){var t=s()-e._sapui_fesr_fDelayedStartTime;F.addBusyDuration(t>0?t:0);delete e._sapui_fesr_fDelayedStartTime}},notifyStepStart:function(e,t,i){if(S){let r,s,o;if(!f&&d||i){if(i){r="startup"}else{r=e}F.start(r,t);f=F.getPending();if(f&&!f.completed&&I?.onInteractionStarted){f.passportAction=I.onInteractionStarted(f,i)}if(d){E=d.srcControl}o=n.getSemanticStepname(E,e);if(t&&t.getId&&E&&t.getId()===E.getId()){g=true}else if(o){f.trigger=E.getId();f.semanticStepName=o;g=true}else{s=E;while(s&&s.getParent()){s=s.getParent();if(t.getId()===s.getId()){l=true;break}}}d=null;u=false;p=setTimeout(function(){d=null},0);b=false;F.notifyStepEnd(true)}else if(f&&E&&!g){s=E;o=n.getSemanticStepname(E,e);if(s&&t.getId()===s.getId()){f.trigger=t.getId();f.semanticStepName=o;f.event=e;g=true}else if(o){f.trigger=E.getId();f.semanticStepName=o;g=true}else if(!l){while(s&&s.getParent()){s=s.getParent();if(t.getId()===s.getId()){f.trigger=t.getId();f.semanticStepName=n.getSemanticStepname(t,e);f.event=e;break}}}}}},notifyControlRendering:function(e,t){if(f){h++;if(a.isLoggable()){a.debug("Interaction relevant step started - Number of pending steps: "+(T+h+y))}return function(){h--;const n=F._a2aNavInfo.get(f.hash);if(f.componentId){if(n&&n===e||e===f.componentId){F.end()}}else{F.end()}F.notifyStepEnd(true);if(a.isLoggable()){a.debug("Interaction relevant step stopped - Number of pending steps: "+(T+h+y))}if(a.isLoggable(null,"sap.ui.Performance")&&t){console.timeEnd(t)}}}else{return function(){}}},notifyAsyncStep:function(e,t){if(f){if(a.isLoggable(null,"sap.ui.Performance")&&t){console.time(t)}var n=f.id;F.notifyAsyncStepStart(e);return function(){F.notifyAsyncStepEnd(e,n);if(a.isLoggable(null,"sap.ui.Performance")&&t){console.timeEnd(t)}}}else{return function(){}}},notifyAsyncStepStart:function(e){if(f){if(e==="request"){y++}else{T++}clearTimeout(m);delete f.legacyEndTime;b=false;if(a.isLoggable()){a.debug("Interaction relevant step started - Number of pending steps: "+(T+h+y))}}},notifyAsyncStepEnd:function(e,t){if(f&&t===f.id){if(e==="request"){y--}else{T--}F.notifyStepEnd(true);if(a.isLoggable()){a.debug("Interaction relevant step stopped - Number of pending steps: "+(T+h+y))}}},notifyStepEnd:function(e){if(S){if(T===0&&h===0&&y===0||!e){if(b||!e){F.end(true);if(a.isLoggable()){a.debug("Interaction stopped")}b=false}else{f.legacyEndTime=s();b=true;if(m){clearTimeout(m)}m=setTimeout(F.notifyStepEnd,301);if(a.isLoggable()){a.debug("Interaction check for bIdle time - Number of pending steps: "+(T+h+y))}}}}},notifyEventStart:function(e){d=S?e:null},notifyScrollEvent:function(e){},notifyEventEnd:function(){if(d){if(d.type.match(/^(mousedown|touchstart|keydown)$/)){F.end(true)}if(this.eventEndTimer){clearTimeout(this.eventEndTimer)}this.eventEndTimer=setTimeout(function(){d=null;delete this.eventEndTimer}.bind(this),10)}},setStepComponent:function(e){if(S&&f&&e&&!f.stepComponent){f.stepComponent=e}},addBusyDuration:function(e){if(S&&f){if(!f.busyDuration){f.busyDuration=0}f.busyDuration+=e}},_setActive:function(e){S=e;if(e){F.notifyStepStart("startup","startup",true);globalThis.addEventListener("hashchange",function(){const e=globalThis.location.hash;const t=e.match(/#([^&/]+)/);if(t?.[0]){if(!v){v=t[0]}else if(v!==t[0]){if(this.getPending()&&!this.getPending().maybeA2A){this.getPending().maybeA2A=t[0]}v=t[0]}}}.bind(this));v=v||globalThis.location.hash.match(/#([^&/]+)/)?.[0]}},_setFESR:function(e){I=e},_a2aNavInfo:new Map,_createOwnerComponentInfo:j};M();B();r.notifyResourceLoading=F.notifyAsyncStep.bind(this,"request");return F});
//# sourceMappingURL=_InteractionImpl.js.map