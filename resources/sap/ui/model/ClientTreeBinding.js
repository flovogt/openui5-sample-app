/*!
  * OpenUI5
 * (c) Copyright 2025 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./ChangeReason","./TreeBinding","sap/base/util/deepEqual","sap/base/util/each","sap/ui/model/FilterProcessor","sap/ui/model/FilterType","sap/ui/model/SorterProcessor"],function(t,e,i,o,s,n,r){"use strict";var h=e.extend("sap.ui.model.ClientTreeBinding",{constructor:function(t,i,o,s,r,h){e.apply(this,arguments);if(!this.oContext){this.oContext=""}this._mLengthsCache={};this.filterInfo={aFilteredContexts:[],iMatches:0,oParentContext:{}};this.oCombinedFilter=null;this.mNormalizeCache={};this.oTreeData=this.cloneData(this.oModel._getObject(this.sPath,this.oContext));if(s){this.oModel.checkFilter(s);if(this.oTreeData){this.filter(s,n.Application)}}}});h.CannotCloneData=Symbol("CannotCloneData");h.prototype.cloneData=function(t){try{return structuredClone(t)}catch{return h.CannotCloneData}};h.prototype.getRootContexts=function(t,e){if(!t){t=0}if(!e){e=this.oModel.iSizeLimit}var i=this.getResolvedPath(),s=this,n,r,h;if(!i){return[]}if(!this.oModel.isList(i)){r=this.oModel.getContext(i);if(this.bDisplayRootNode){n=[r]}else{n=this.getNodeContexts(r,t,e)}}else{n=[];h=this._sanitizePath(i);o(this.oModel._getObject(h),function(t,e){s._saveSubContext(e,n,h,t)});this._applySorter(n);this._setLengthCache(h,n.length);n=n.slice(t,t+e)}return n};h.prototype.getNodeContexts=function(t,e,i){if(!e){e=0}if(!i){i=this.oModel.iSizeLimit}var o=this._sanitizePath(t.getPath());var s=[],n=this,r=this.oModel._getObject(o),h=this.mParameters&&this.mParameters.arrayNames,a;if(r){if(Array.isArray(r)){r.forEach(function(t,e){n._saveSubContext(t,s,o,e)})}else{a=h||Object.keys(r);a.forEach(function(t){var e=r[t];if(e){if(Array.isArray(e)){e.forEach(function(e,i){n._saveSubContext(e,s,o,t+"/"+i)})}else if(typeof e=="object"){n._saveSubContext(e,s,o,t)}}})}}this._applySorter(s);this._setLengthCache(o,s.length);return s.slice(e,e+i)};h.prototype.hasChildren=function(t){if(t==undefined){return false}return this.getChildCount(t)>0};h.prototype.getChildCount=function(t){var e=t?t.sPath:this.getPath();if(this.oContext){e=this.oModel.resolve(e,this.oContext)}e=this._sanitizePath(e);if(this._mLengthsCache[e]===undefined){if(t){this.getNodeContexts(t)}else{this.getRootContexts()}}return this._mLengthsCache[e]};h.prototype._sanitizePath=function(t){if(!t.endsWith("/")){t=t+"/"}if(!t.startsWith("/")){t="/"+t}return t};h.prototype._saveSubContext=function(t,e,i,o){if(t&&typeof t=="object"){var s=this.oModel.getContext(i+o);if(this.oCombinedFilter&&!this.bIsFiltering){if(this.filterInfo.aFilteredContexts.indexOf(s)!=-1){e.push(s)}}else{e.push(s)}}};h.prototype.filter=function(e,i){if(e&&!Array.isArray(e)){e=[e]}this.oModel.checkFilter(e);if(i==n.Application){this.aApplicationFilters=e||[]}else if(i==n.Control){this.aFilters=e||[]}else{this.aFilters=e||[];this.aApplicationFilters=[]}this.oCombinedFilter=s.combineFilters(this.aFilters,this.aApplicationFilters);if(this.oCombinedFilter){this.applyFilter()}this._mLengthsCache={};this._fireChange({reason:t.Filter});this._fireFilter({filters:e});return this};h.prototype.applyFilter=function(){this.filterInfo.aFilteredContexts=[];this.filterInfo.iMatches=0;this.filterInfo.oParentContext={};this._applyFilterRecursive()};h.prototype._applyFilterRecursive=function(t){var e=this,i=[];if(!this.oCombinedFilter){return}this.bIsFiltering=true;var n;if(t){n=this.getNodeContexts(t,0,Number.MAX_VALUE)}else{n=this.getRootContexts(0,Number.MAX_VALUE)}this.bIsFiltering=false;if(n.length>0){o(n,function(i,o){o._parentContext=t;e._applyFilterRecursive(o)});i=s.apply(n,this.oCombinedFilter,function(t,i){return e.oModel.getProperty(i,t)},this.mNormalizeCache);if(i.length>0){this.filterInfo.aFilteredContexts=this.filterInfo.aFilteredContexts.concat(i);this.filterInfo.aFilteredContexts.push(t);this.filterInfo.oParentContext=t;this.filterInfo.iMatches+=i.length}if(n.indexOf(this.filterInfo.oParentContext)!=-1){this.filterInfo.aFilteredContexts.push(t);this.filterInfo.oParentContext=t}}};h.prototype.sort=function(e){e=e||[];this.aSorters=Array.isArray(e)?e:[e];this._fireChange({reason:t.Sort});return this};h.prototype._applySorter=function(t){var e=this;r.apply(t,this.aSorters,function(t,i){return e.oModel.getProperty(i,t)},function(t){return t.getPath()})};h.prototype._setLengthCache=function(t,e){this._mLengthsCache[t]=e};h.prototype.setContext=function(e){if(this.oContext!=e){this.oContext=e;if(this.isRelative()){const e=this.oModel._getObject(this.sPath,this.oContext);this.oTreeData=this.cloneData(e);this._fireChange({reason:t.Context})}}};h.prototype.checkUpdate=function(e){const o=this.oModel._getObject(this.sPath,this.oContext);this.applyFilter();this._mLengthsCache={};if(e||!i(this.oTreeData,o)){this.oTreeData=this.cloneData(o);this._fireChange({reason:t.Change})}};h.prototype.getCount=function(){if(!this.isResolved()){return undefined}if(this.oCombinedFilter){return this.filterInfo.iMatches}return h._getTotalNodeCount(this.oModel.getObject(this.getResolvedPath()),this.mParameters&&this.mParameters.arrayNames,true)};h._getTotalNodeCount=function(t,e,i){if(t===null||typeof t!=="object"){return 0}if(Array.isArray(t)){return t.reduce(function(t,i){return t+h._getTotalNodeCount(i,e)},0)}return(e||Object.keys(t)).reduce(function(i,o){return i+h._getTotalNodeCount(t[o],e)},i?0:1)};return h});
//# sourceMappingURL=ClientTreeBinding.js.map