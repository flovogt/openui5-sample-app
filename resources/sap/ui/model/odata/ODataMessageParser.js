/*!
 * OpenUI5
 * (c) Copyright 2025 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/core/Lib","sap/ui/model/odata/ODataMetadata","sap/ui/model/odata/ODataUtils","sap/ui/core/Messaging","sap/ui/core/message/MessageParser","sap/ui/core/message/Message","sap/ui/core/message/MessageType","sap/base/Log"],function(e,t,r,s,a,i,n,o){"use strict";var d="sap.ui.model.odata.ODataMessageParser",u=/^\/+|\/$/g,c={error:n.Error,info:n.Information,success:n.Success,warning:n.Warning};const l=/[?#]/;var h=a.extend("sap.ui.model.odata.ODataMessageParser",{metadata:{publicMethods:["parse","setProcessor","getHeaderField","setHeaderField"]},constructor:function(e,t,r){a.apply(this);this._sRelativeServerUrl=h.getRelativeServerUrl(h._removeParametersAndHash(e));this._metadata=t;this._headerField="sap-message";this._lastMessages=[];this._bPersistTechnicalMessages=r}});h.prototype.getHeaderField=function(){return this._headerField};h.prototype.setHeaderField=function(e){this._headerField=e;return this};h.prototype.parse=function(e,t,r,s,a){var i,n,u=String(e.statusCode);if(t.method==="GET"&&u==="204"){return}n={request:t,response:e,url:t.requestUri};if(e.statusCode>=200&&e.statusCode<300){i=this._parseHeader(e,n)}else if(e.statusCode>=400&&e.statusCode<600){try{i=this._parseBody(e,n)}catch(e){i=this._createGenericError(n);o.debug("Failed to parse error messages from the response body",e,d)}finally{this._logErrorMessages(i,t,u)}}else{i=this._createGenericError(n);o.error("Request failed with unsupported status code "+u+": "+t.method+" "+t.requestUri,undefined,d)}if(t.method==="GET"&&u==="424"){return}this._propagateMessages(i,n,r,s,!a)};h.prototype._getAffectedTargets=function(e,t,r,s){var a=Object.assign({"":true},r,s),i,n=h._removeParametersAndHash(t.url);if(t.request.key&&t.request.created){a[t.request.key]=true}if(n.startsWith(this._sRelativeServerUrl)){n=n.slice(this._sRelativeServerUrl.length+1)}i=this._metadata._getEntitySetByPath(n);if(i){a[i.name]=true}e.forEach(function(e){e.getTargets().forEach(function(e){var t,r,s;if(!e){return}s=e.replace(u,"");a[s]=true;r=s.lastIndexOf("/");if(r>0){t=s.slice(0,r);a[t]=true}})});return a};h.prototype._propagateMessages=function(e,r,a,i,n){var c,l=r.request.deepPath,h=[],g,f=l&&r.request.updateAggregatedMessages,p=r.request.headers&&r.request.headers["sap-messages"]==="transientOnly",y=[],_=t._returnsCollection(r.request.functionMetadata),m,v,M;function T(e,t){return t.some(function(e){return c[e]})||f&&e.aFullTargets.some(function(e){if(_){return g.some(function(t){var r=t.slice(t.indexOf("("));return e.startsWith(l+r)})}else{return e.startsWith(l)}})}a=a||{};if(p){h=this._lastMessages;m=e.some(function(e){return!e.getPersistent()&&!e.getTechnical()});if(m){o.error("Unexpected non-persistent message in response, but requested only "+"transition messages",undefined,d)}}else{c=this._getAffectedTargets(e,r,a,i);g=Object.keys(a);v=r.response.statusCode;M=v>=200&&v<300;this._lastMessages.forEach(function(e){var t=e.getTargets().map(function(e){e=e.replace(u,"");var t=e.lastIndexOf(")/");if(t>0){e=e.substr(0,t+1)}return e});if(M||n){if(!e.getPersistent()&&T(e,t)){y.push(e)}else{h.push(e)}}else if(!e.getPersistent()&&e.getTechnical()&&T(e,t)){y.push(e)}else{h.push(e)}})}s.updateMessages(y,e);this._lastMessages=h.concat(e)};h.prototype._createMessage=function(e,t,r){var s=e.target&&e.target.indexOf("/#TRANSIENT#")===0||e.transient||e.transition||r&&this._bPersistTechnicalMessages,a,n=typeof e.message==="object"?e.message.value:e.message,o=e["@sap.severity"]||e.severity;e.transition=!!s;a=this._createTargets(e,t,r);return new i({code:e.code||"",description:e.description,descriptionUrl:e.longtext_url||"",fullTarget:a.aDeepPaths,message:n,persistent:!!s,processor:this._processor,target:a.aTargets,technical:r,technicalDetails:{headers:t.response.headers,statusCode:t.response.statusCode},type:c[o]||o})};h._isResponseForCreate=function(e){var t=e.request,r=e.response;if(t.method==="POST"&&r.statusCode==201&&r.headers["location"]){return true}if(t.key&&t.created&&r.statusCode>=400){return false}return undefined};h.prototype._createTarget=function(e,t,s,a){var i,n,o,d,u,c,l,g,f=t.request,p=t.response;if(e===undefined&&(!s&&f.headers["sap-message-scope"]==="BusinessObject"||s&&a)){return{deepPath:"",target:""}}e=e||"";e=e.startsWith("/#TRANSIENT#")?e.slice(12):e;if(e[0]!=="/"){n=h._isResponseForCreate(t);o=f.deepPath||"";if(n===true){g=p.headers["location"]}else if(n===false){g=f.key}else{g=t.url}l=h._removeParametersAndHash(g);d=l.indexOf(this._sRelativeServerUrl);if(d>-1){c=l.slice(d+this._sRelativeServerUrl.length)}else{c="/"+l}if(!n&&f.functionMetadata){c=f.functionTarget}if(c.slice(c.lastIndexOf("/")).indexOf("(")>-1||!this._metadata._isCollection(c)){o=e?o+"/"+e:o;e=e?c+"/"+e:c}else{o=o+e;e=c+e}}i=this._processor.resolve(e,undefined,true);while(i&&i.lastIndexOf("/")>0&&i!==u){u=i;i=this._processor.resolve(i,undefined,true)||u}e=i||e;return{deepPath:r._normalizeKey(this._metadata._getReducedPath(o||e)),target:r._normalizeKey(e)}};h.prototype._createTargets=function(e,t,r){var s=[],a=Array.isArray(e.additionalTargets)?[e.target].concat(e.additionalTargets):[e.target],i,n=[],u=this;if(e.propertyref!==undefined&&a[0]!==undefined){o.warning("Used the message's 'target' property for target calculation; the property"+" 'propertyref' is deprecated and must not be used together with 'target'",t.url,d)}else if(a[0]===undefined){a[0]=e.propertyref}a.forEach(function(a){i=u._createTarget(a,t,r,e.transition);s.push(i.deepPath);n.push(i.target)});return{aDeepPaths:s,aTargets:n}};h.prototype._parseHeader=function(e,t){var r,s,a,i,n=this.getHeaderField(),d=[];if(!e.headers){return d}for(s in e.headers){if(s.toLowerCase()===n.toLowerCase()){n=s}}if(!e.headers[n]){return d}a=e.headers[n];try{i=JSON.parse(a);d.push(this._createMessage(i,t));if(Array.isArray(i.details)){for(r=0;r<i.details.length;r+=1){d.push(this._createMessage(i.details[r],t))}}}catch(e){o.error("The message string returned by the back-end could not be parsed: '"+e.message+"'");return d}return d};h.prototype._parseBody=function(e,t){var r=g(e);return r&&r.indexOf("xml")>-1?this._parseBodyXML(e,t,r):this._parseBodyJSON(e,t)};h.prototype._createGenericError=function(t){return[this._createMessage({description:t.response.body,message:e.getResourceBundleFor("sap.ui.core").getText("CommunicationError"),severity:n.Error,transition:true},t,true)]};h.prototype._getBodyMessages=function(e,t,r){var s=r.request.headers["Content-ID"],a=[],i=this._createMessage(e,r,true),n=this;t.forEach(function(e){var t=n._createMessage(e,r,true);if(i&&i.getCode()===t.getCode()&&i.getMessage()===t.getMessage()){i=undefined}if(!s||!e.ContentID||s===e.ContentID){a.push(t)}});if(i){a.unshift(i)}return a};h.prototype._logErrorMessages=function(e,t,r){var s=e.length?JSON.stringify(e.map(function(e){return{code:e.getCode(),message:e.getMessage(),persistent:e.getPersistent(),targets:e.getTargets(),type:e.getType()}})):"Another request in the same change set failed";o.error("Request failed with status code "+r+": "+t.method+" "+t.requestUri,s,d)};h.prototype._parseBodyXML=function(e,t,r){var s,a,i,o,d,u,c,l=(new DOMParser).parseFromString(e.body,r),h=f(l,["error","errordetail"]),g=[];if(!h.length){return this._createGenericError(t)}for(o=0;o<h.length;o+=1){c=h[o];i={};i.severity=n.Error;for(u=0;u<c.childNodes.length;u+=1){s=c.childNodes[u];a=s.nodeName;if(a==="errordetails"||a==="details"||a==="innererror"||a==="#text"){continue}if(a==="message"&&s.hasChildNodes()&&s.firstChild.nodeType!==window.Node.TEXT_NODE){for(d=0;d<s.childNodes.length;d+=1){if(s.childNodes[d].nodeName==="value"){i.message=s.childNodes[d].text||s.childNodes[d].textContent}}}else{i[s.nodeName]=s.text||s.textContent}}g.push(i)}return this._getBodyMessages(g[0],g.slice(1),t)};h.prototype._parseBodyJSON=function(e,t){var r,s,a=JSON.parse(e.body);if(a.error){s=a.error}else{s=a["odata.error"]}if(!s){o.error("Error message returned by server did not contain error-field");return this._createGenericError(t)}s.severity=n.Error;if(Array.isArray(s.details)){r=s.details}else if(s.innererror&&Array.isArray(s.innererror.errordetails)){r=s.innererror.errordetails}else{r=[]}return this._getBodyMessages(s,r,t)};h._removeParametersAndHash=function(e){return e.split(l)[0]};h.prototype._setPersistTechnicalMessages=function(e){this._bPersistTechnicalMessages=e};h.getRelativeServerUrl=function(e){return new URL(e,document.baseURI).pathname};function g(e){if(e&&e.headers){for(var t in e.headers){if(t.toLowerCase()==="content-type"){return e.headers[t].replace(/([^;]*);.*/,"$1")}}}return false}function f(e,t){var r=[];var s={};for(var a=0;a<t.length;a+=1){s[t[a]]=true}var i=e;while(i){if(s[i.tagName]){r.push(i)}if(i.hasChildNodes()){i=i.firstChild}else{while(!i.nextSibling){i=i.parentNode;if(!i||i===e){i=null;break}}if(i){i=i.nextSibling}}}return r}return h});
//# sourceMappingURL=ODataMessageParser.js.map