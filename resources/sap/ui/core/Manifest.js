/*
 * OpenUI5
 * (c) Copyright 2025 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/assert","sap/base/i18n/Localization","sap/ui/base/Object","sap/ui/VersionInfo","sap/base/util/Version","sap/base/future","sap/base/Log","sap/ui/dom/includeStylesheet","sap/ui/util/_URL","sap/base/i18n/ResourceBundle","sap/base/util/uid","sap/base/util/merge","sap/base/util/isPlainObject","sap/base/util/LoaderExtensions","sap/base/config","sap/ui/core/Supportability","sap/ui/core/Lib","./_UrlResolver"],function(e,n,i,t,s,r,a,o,u,c,f,l,p,h,d,m,g,v){"use strict";function _(e){const n=[];e.forEach(e=>{const i=s(e);if(n.includes(i.getMajor())){throw new Error(`The minimal UI5 versions defined in the manifest must not include multiple versions with the same major version, Component: ${this.getComponentName()}.`)}else{n.push(i.getMajor())}})}function b(e){let n=e;if(Array.isArray(e)){n=e.sort()[0];_.call(this,e)}const i=s(n);return i.getSuffix()?s(i.getMajor()+"."+i.getMinor()+"."+i.getPatch()):i}function y(e,n){if(e&&n&&typeof n==="string"&&n[0]==="/"){var i=n.substring(1).split("/"),t;for(var s=0,r=i.length;s<r;s++){t=i[s];e=Object.hasOwn(e,t)?e[t]:undefined;if(e===null||typeof e!=="object"){if(s+1<r&&e!==undefined){e=undefined}break}}return e}return e&&e[n]}function U(e){if(e&&typeof e==="object"&&!Object.isFrozen(e)){Object.freeze(e);for(var n in e){if(Object.hasOwn(e,n)){U(e[n])}}}}var w=i.extend("sap.ui.core.Manifest",{constructor:function(e,n){i.apply(this,arguments);this._uid=f();this._iInstanceCount=0;this._oRawManifest=e;this._bProcess=!(n&&n.process===false);this._bAsync=!(n&&n.async===false);this._activeTerminologies=n&&n.activeTerminologies;this._bLoadManifestRequestFailed=n&&n._bLoadManifestRequestFailed;this._sComponentName=n&&n.componentName;var t=this.getComponentName(),s=n&&n.baseUrl||t&&sap.ui.require.toUrl(t.replace(/\./g,"/"))+"/";if(s){this._oBaseUri=new u(s,document.baseURI)}if(n&&typeof n.url==="string"){this._oManifestBaseUri=new u(n.url,document.baseURI);this._oManifestBaseUri.search=""}else{this._oManifestBaseUri=this._oBaseUri}U(this._oRawManifest);this._oManifest=l({},this._oRawManifest);if(this._bProcess){this._processI18n()}},_processI18n:function(e,n){if(!n){n=[];this._preprocess({i18nProperties:n})}if(n.length>0){var i=function(e){var i=function(n,i){return e.getText(i)};for(var t=0,s=n.length;t<s;t++){var r=n[t];r.object[r.key]=r.object[r.key].replace(w._rManifestTemplate,i)}};if(e){return this._loadI18n(e).then(i)}else{i(this._loadI18n(e))}}else{return e?Promise.resolve():undefined}},_loadI18n:function(e){var n=this._oRawManifest,i="manifest",t=n["sap.app"]&&n["sap.app"]["i18n"]||"i18n/i18n.properties";if(typeof t==="string"){return c.create({url:this.resolveUri(t,i),async:e})}else if(typeof t==="object"){t=JSON.parse(JSON.stringify(t));i=t.bundleUrlRelativeTo||i;v._processResourceConfiguration(t,{alreadyResolvedOnRoot:false,baseURI:this._oBaseUri,manifestBaseURI:this._oManifestBaseUri,relativeTo:i});var s=Object.assign({activeTerminologies:this._activeTerminologies,async:e},t);return c.create(s)}},getJson:function(){return this._oManifest},getRawJson:function(){return this._oRawManifest},getEntry:function(e){if(!e||e.indexOf(".")<=0){r.warningThrows("Manifest entries with keys without namespace prefix can not be read via getEntry. Key: "+e+", Component: "+this.getComponentName());return null}var n=this.getJson();var i=y(n,e);if(e&&e[0]!=="/"&&i!==undefined&&!p(i)){r.warningThrows("Manifest entry with key '"+e+"' must be an object. Component: "+this.getComponentName());return null}return i},checkUI5Version:async function(){var e=this.getEntry("/sap.ui5/dependencies/minUI5Version");if(e&&a.isLoggable(a.Level.WARNING)&&m.isDebugModeEnabled()){const n=await t.load().catch(e=>{a.warning('The validation of the version for Component "'+this.getComponentName()+'" failed! Reason: '+e)});const i=b.call(this,e);const s=b.call(this,n?.version);if(i.compareTo(s)>0){a.warning('Component "'+this.getComponentName()+'" requires at least version "'+i.toString()+'" but running on "'+s.toString()+'"!')}}},_getSchemaVersion:function(){const e=this.getJson();const n=y(e,"/_version");return new s(n).getMajor()},_loadIncludes:function(e){var n=this.getEntry("/sap.ui5/resources"),i;if(!n){return}var t=this.getComponentName();if(n["js"]){if(this._getSchemaVersion()===2){throw new Error(`'sap.ui5/resources/js' is deprecated and not supported with manifest version 2 (component '${t}'.`)}var s=n["js"];var r=function(e){return function(){return new Promise(function(n,i){sap.ui.require([e],n,i)})}};i=Promise.resolve();for(var u=0;u<s.length;u++){var c=s[u];var f=c.uri;if(f){var l=f.match(/\.js$/i);if(l){var p=t.replace(/\./g,"/")+(f.slice(0,1)==="/"?"":"/")+f.slice(0,l.index);a.info('Component "'+t+'" is loading JS: "'+p+'"');if(e){i=i.then(r(p))}else{sap.ui.requireSync(p)}}}}}var h=n["css"];if(h){for(var d=0;d<h.length;d++){var m=h[d];if(m.uri){var g=this.resolveUri(m.uri);a.info('Component "'+t+'" is loading CSS: "'+g+'"');o(g,{id:m.id,"data-sap-ui-manifest-uid":this._uid})}}}return i},removeIncludes:function(){var e=this.getEntry("/sap.ui5/resources");if(!e){return}var n=this.getComponentName();var i=e["css"];if(i){var t=document.querySelectorAll("link[data-sap-ui-manifest-uid='"+this._uid+"']");for(var s=0;s<t.length;s++){var r=t[s];a.info('Component "'+n+'" is removing CSS: "'+r.href+'"');r.parentNode.removeChild(r)}}},_loadDependencies:function(e){var n=[];var i=this.getEntry("/sap.ui5/dependencies"),t=this.getComponentName();if(i){var s=i["libs"];if(s){for(var r in s){if(!s[r].lazy){a.info('Component "'+t+'" is loading library: "'+r+'"');n.push(g._load(r,{sync:!e}))}}}var o=i["components"];if(o){var u=[];for(var c in o){if(!o[c].lazy){u.push(c)}}if(u.length>0){if(e){var f=new Promise(function(e,n){sap.ui.require(["sap/ui/core/Component"],function(n){e(n)},n)}).then(function(e){return Promise.all(u.map(function(n){return e.load({name:n,manifest:false})}))});n.push(f)}else{u.forEach(function(e){var n=e.replace(/\./g,"/")+"/Component";var i=sap.ui.loader._.getModuleState(n+".js");if(i===-1){sap.ui.requireSync(n)}else if(i===0){a.info('Component "'+t+'" is loading component: "'+e+'.Component"');sap.ui.requireSync("sap/ui/core/Component");sap.ui.component.load({name:e})}})}}}}return Promise.all(n)},defineResourceRoots:function(){var e=this.getEntry("/sap.ui5/resourceRoots");if(e){for(var n in e){var i=e[n];var t=new u(i);if(t.isAbsolute()||t.plainUrl?.[0]==="/"){r.errorThrows(`${this.getComponentName()}: Resource root for "${n}" is absolute and therefore won't be registered! "${i}"`);continue}i=this.resolveUri(i);var s={};s[n.replace(/\./g,"/")]=i;sap.ui.loader.config({paths:s})}}},getComponentName:function(){var e=this.getRawJson();return this._sComponentName||y(e,"/sap.ui5/componentName")||y(e,"/sap.app/id")},resolveUri:function(n,i){e(n!==undefined&&typeof n==="string","'sUri' must be of type 'string'");var t=i==="manifest"?this._oManifestBaseUri:this._oBaseUri;var s=v._resolveUri(n,t);return s&&s.sourceUrl},_preprocess:function(e){w.processObject(this._oManifest,function(n,i,t){if(e.resolveUI5Urls&&t.startsWith("ui5:")){n[i]=h.resolveUI5Url(t)}else if(e.i18nProperties&&t.match(w._rManifestTemplate)){e.i18nProperties.push({object:n,key:i})}})},init:function(e){if(this._iInstanceCount===0){this.loadDependenciesAndIncludes()}this._iInstanceCount++},loadDependenciesAndIncludes:function(e){if(this._pDependenciesAndIncludes){return this._pDependenciesAndIncludes}const n=this.checkUI5Version();this.defineResourceRoots();this._preprocess({resolveUI5Urls:true});this._pDependenciesAndIncludes=Promise.all([this._loadDependencies(e),this._loadIncludes(e),n]);return this._pDependenciesAndIncludes},exit:function(e){var n=Math.max(this._iInstanceCount-1,0);if(n===0){this.removeIncludes();delete this._pDependenciesAndIncludes}this._iInstanceCount=n}});w._rManifestTemplate=/\{\{([^\}\}]+)\}\}/g;w.load=function(e){var i=e&&e.manifestUrl,t=e&&e.componentName,s=e&&e.async,r=e&&e.failOnError,o=e&&e.processJson;var c=new u(i);if(!c.searchParams.has("sap-language")){const e=n.getSAPLogonLanguage();if(e){c.searchParams.set("sap-language",e)}}if(!c.searchParams.has("sap-client")){const e=d.get({name:"sapClient",type:d.Type.String,external:true});if(e){c.searchParams.set("sap-client",e)}}i=c.sourceUrl;a.info("Loading manifest via URL: "+i);if(!s){a.warning("Synchronous loading of manifest, due to Manifest.load() call for '"+i+"'. Use parameter 'async' true to avoid this.","SyncXHR",null,function(){return{type:"SyncXHR",name:"Manifest"}})}var f=h.loadResource({url:i,dataType:"json",async:typeof s!=="undefined"?s:false,headers:{"Accept-Language":n.getLanguageTag().toString()},failOnError:typeof r!=="undefined"?r:true});var l={componentName:t,url:i,process:false};if(e.activeTerminologies){l["activeTerminologies"]=e.activeTerminologies}if(s){return f.then(function(e){if(o&&e){return o(e)}else{return e}}).then(function(e){if(!e){l._bLoadManifestRequestFailed=true}return new w(e,l)})}return new w(f,l)};w.processObject=function(e,n){for(var i in e){if(!Object.hasOwn(e,i)){continue}var t=e[i];switch(typeof t){case"object":if(t){w.processObject(t,n)}break;case"string":n(e,i,t);break;default:}}};return w});
//# sourceMappingURL=Manifest.js.map