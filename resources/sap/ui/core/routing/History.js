/*!
 * OpenUI5
 * (c) Copyright 2025 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/Device","sap/ui/core/library","./HashChanger","sap/base/future","sap/base/Log"],function(t,i,s,e,a){"use strict";var r=i.routing.HistoryDirection;var n="Direction_Unchanged";var o=function(t){var i=this;this._iHistoryLength=window.history.length;this.aHistory=[];this._bIsInitial=true;function s(t){if(o._bUsePushState&&!o.getInstance()){var s=window.history.state===null?{}:window.history.state;if(typeof s==="object"){s.sap=s.sap?s.sap:{};if(s.sap.history&&Array.isArray(s.sap.history)&&s.sap.history[s.sap.history.length-1]===t){o._aStateHistory=s.sap.history}else{o._aStateHistory.push(t);s.sap.history=o._aStateHistory;window.history.replaceState(s,window.document.title)}}else{a.debug("Unable to determine HistoryDirection as history.state is already set: "+window.history.state,"sap.ui.core.routing.History")}}i._reset()}if(!t){e.errorThrows("sap.ui.core.routing.History constructor was called and it did not get a hashChanger as parameter")}this._setHashChanger(t);if(t._initialized){s(t.getHash())}else{t.attachEventOnce("hashChanged",function(t){s(t.getParameter("newHash"))})}};o._aStateHistory=[];o._bUsePushState=!t.browser.safari&&window.self===window.top;o.prototype.getHistoryStateOffset=function(){if(!o._bUsePushState){return undefined}var t=window.history.state?.sap?.history;if(!Array.isArray(t)){return undefined}return t.length-o._aStateHistory.length};o.prototype.destroy=function(){this._unRegisterHashChanger()};o.prototype.getDirection=function(t){if(t!==undefined&&this._bIsInitial){return undefined}if(t===undefined){return this._sCurrentDirection}return this._getDirection(t)};o.prototype.getPreviousHash=function(){return this.aHistory[this.iHistoryPosition-1]};o.prototype._setHashChanger=function(t){if(this._oHashChanger){this._unRegisterHashChanger()}this._oHashChanger=t;this._mEventListeners={};t.getRelevantEventsInfo().forEach(function(t){var i=t.name,s=t.paramMapping||{},e=this._onHashChange.bind(this,s);this._mEventListeners[i]=e;this._oHashChanger.attachEvent(i,e,this)}.bind(this));this._oHashChanger.attachEvent("hashReplaced",this._hashReplaced,this);this._oHashChanger.attachEvent("hashSet",this._hashSet,this)};o.prototype._unRegisterHashChanger=function(){if(this._mEventListeners){var t=Object.keys(this._mEventListeners);t.forEach(function(t){this._oHashChanger.detachEvent(t,this._mEventListeners[t],this)}.bind(this));delete this._mEventListeners}this._oHashChanger.detachEvent("hashReplaced",this._hashReplaced,this);this._oHashChanger.detachEvent("hashSet",this._hashSet,this);this._oHashChanger=null};o.prototype._reset=function(){this.aHistory.length=0;this.iHistoryPosition=0;this._bUnknown=true;this.aHistory[0]=this._oHashChanger.getHash()};o.prototype._getDirection=function(t,i,s){if(s&&this._oNextHash&&this._oNextHash.sHash===t){return r.NewEntry}if(i){return r.NewEntry}if(this._bUnknown){return r.Unknown}if(this.aHistory[this.iHistoryPosition+1]===t&&this.aHistory[this.iHistoryPosition-1]===t){return r.Unknown}if(this.aHistory[this.iHistoryPosition-1]===t){return r.Backwards}if(this.aHistory[this.iHistoryPosition+1]===t){return r.Forwards}return r.Unknown};o.prototype._getDirectionWithState=function(t){var i=window.history.state===null?{}:window.history.state,s,e;if(typeof i==="object"){if(i.sap===undefined){o._aStateHistory.push(t);i.sap={};i.sap.history=o._aStateHistory;window.history.replaceState(i,document.title);e=r.NewEntry}else{s=i.sap.history.every(function(t,i){return t===o._aStateHistory[i]});if(s&&i.sap.history.length===o._aStateHistory.length){e=n}else{e=s?r.Backwards:r.Forwards;o._aStateHistory=i.sap.history}}}else{a.debug("Unable to determine HistoryDirection as history.state is already set: "+window.history.state,"sap.ui.core.routing.History")}return e};o.prototype._onHashChange=function(t,i){var s=t.newHash||"newHash",e=t.oldHash||"oldHash",a=t.fullHash||"fullHash";this._hashChange(i.getParameter(s),i.getParameter(e),i.getParameter(a))};o.prototype._hashChange=function(t,i,s){var e=window.history.length,a;if(this._oNextHash&&this._oNextHash.bWasReplaced&&this._oNextHash.sHash===t){if(this._oNextHash.sDirection){a=this._oNextHash.sDirection}else{this.aHistory[this.iHistoryPosition]=t;if(s!==undefined&&o._bUsePushState&&this===o.getInstance()){o._aStateHistory[o._aStateHistory.length-1]=s;window.history.replaceState({sap:{history:o._aStateHistory}},window.document.title)}this._oNextHash=null;if(!this._bIsInitial){this._sCurrentDirection=r.Unknown}return}}this._bIsInitial=false;if(a){this._adaptToDirection(a,{oldHash:i,newHash:t,fullHash:s})}else{if(!a&&s!==undefined&&o._bUsePushState&&this===o.getInstance()){a=this._getDirectionWithState(s)}if(a===n){return}if(!a){a=this._getDirection(t,this._iHistoryLength<window.history.length,true)}this._bUnknown=false;switch(a){case r.Unknown:this._reset();break;case r.NewEntry:this.aHistory.splice(this.iHistoryPosition+1,this.aHistory.length-this.iHistoryPosition-1,t);this.iHistoryPosition++;break;case r.Forwards:this.iHistoryPosition++;break;case r.Backwards:this.iHistoryPosition--;break;default:break}}this._sCurrentDirection=a;this._iHistoryLength=e;if(this._oNextHash){this._oNextHash=null}};o.prototype._adaptToDirection=function(t,i){var s=i.fullHash,e=i.newHash,n,h;if(o._bUsePushState&&this===o.getInstance()&&s!==undefined){switch(t){case r.NewEntry:case r.Forwards:o._aStateHistory.push(s);break;case r.Backwards:n=o._aStateHistory.lastIndexOf(s);if(n!==-1){o._aStateHistory.splice(n+1)}else{o._aStateHistory=[s];a.debug("Can't find "+s+" in "+JSON.stringify(o._aStateHistory))}break;case r.Unknown:o._aStateHistory[o._aStateHistory.length-1]=s;break;default:break}h={};h.sap={};h.sap.history=o._aStateHistory;window.history.replaceState(h,document.title)}switch(t){case r.NewEntry:this.aHistory.splice(this.iHistoryPosition+1,this.aHistory.length-this.iHistoryPosition-1,e);this.iHistoryPosition+=1;break;case r.Forwards:n=this.aHistory.indexOf(e,this.iHistoryPosition+1);if(n!==-1){this.iHistoryPosition=n}else{this.aHistory.splice(this.iHistoryPosition+1,this.aHistory.length-this.iHistoryPosition-1,e);this.iHistoryPosition++}break;case r.Backwards:n=this.aHistory.lastIndexOf(e,this.iHistoryPosition-1);if(n!==-1){this.iHistoryPosition=n}else{this.aHistory=[e];this.iHistoryPosition=0}break;case r.Unknown:this.aHistory[this.iHistoryPosition]=e;break;default:break}};o.prototype._hashSet=function(t){var i=t.getParameter("hash");if(i===undefined){i=t.getParameter("sHash")}this._hashChangedByApp(i,false)};o.prototype._hashReplaced=function(t){var i=t.getParameter("hash"),s=t.getParameter("direction");if(i===undefined){i=t.getParameter("sHash")}if(i===this._oHashChanger.getHash()&&s){this._sCurrentDirection=s;return}this._hashChangedByApp(i,true,s)};o.prototype._hashChangedByApp=function(t,i,s){this._oNextHash={sHash:t,bWasReplaced:i,sDirection:s}};var h;o.getInstance=function(){return h};h=new o(s.getInstance());return o},true);
//# sourceMappingURL=History.js.map